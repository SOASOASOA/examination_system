<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>组织结构</title>
<link rel="stylesheet" type="text/css" href="../layui/css/layui.css">
<script type="text/javascript" src="../layui/layui.js"></script>
<link rel="stylesheet" href="../css/zTreeStyle/zTreeStyle.css" type="text/css">
<style type="text/css">
html, body {
	height: 100%;
	background-color: #fff;
	position: relative;
}

#left_div {
	width: 250px;
	position: absolute;
	top: 0px;
	bottom: 0px;
	border-right: 1.5px solid #DADADA;
}

#right_div {
	position: absolute;
	left: 250px;
	top: 0px;
	bottom: 0px;
	right: 0px;
}

.right_div_head {
	margin-top: 5px;
	height: 45px;
	border-bottom: 1px solid #DADADA;
}

#keyword {
	float: left;
	width: 300px;
}

#keyword {
	margin-left: 5%;
}

.right_div_head .layui-icon {
	font-size: 35px;
	color: #666666;
}

#um_create_person {
	float: right;
	margin-right: 10%;
}

.my-layui-btn-none {
	background-color: black;
}
#update_person_form{
	display: none;
	margin-left: 20%;
}
input[readonly] {
	background-color: #F1F1F1;
}
#reset_password{
	margin-left: 10px;
}
</style>
</head>
<body>
	<div id="left_div">
		<ul id="oaganization_tree" class="ztree"></ul>
	</div>
	<div id="right_div">
		<div class="right_div_head">
			<input id="keyword" type="text" placeholder="请输入搜索关键词" autocomplete="off" class="layui-input"> <i class="layui-icon">&#xe615;</i>
			<button id="um_create_person" class="layui-btn layui-btn-normal">添加新用户</button>
		</div>
		<table id="um_c_table" class="layui-table" lay-filter="um_c_table_filter" lay-skin="line"></table>
		<button id="reset_password" class="layui-btn layui-btn-danger">初始化密码</button>
	</div>
	<form id="update_person_form" class="layui-form">
		<legend style="color: red">必填项:</legend>
		<div class="layui-form-item">
			<label class="layui-form-label">登录账号:</label>
			<div class="layui-input-inline">
				<input type="text" name="user_account" lay-verify="user_account" placeholder="" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">姓&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp名</label>
			<div class="layui-input-inline">
				<input type="text" name="user_name" lay-verify="required" placeholder="" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">职务/权限</label>
			<div class="layui-input-inline">
				<input type="text" name="role_name" lay-verify="required" placeholder="" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">证件号码</label>
			<div class="layui-input-inline">
				<input type="text" name="user_certificaiton_num" required lay-verify="required" placeholder="" autocomplete="off" class="layui-input">
			</div>
		</div>
		<legend style="color: green;">选填项:</legend>
		<div class="layui-form-item">
			<label class="layui-form-label">单&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp位</label>
			<div class="layui-input-inline">
				<input type="text" name="user_company"  lay-verify="" placeholder="" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">联系方式:</label>
			<div class="layui-input-inline">
				<input type="text" name="user_phone_num"   placeholder="" autocomplete="off" class="layui-input">
			</div>
			<div class="layui-form-mid layui-word-aux">
				<span style="color: red">*</span>电话号码格式:手机或固话
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">Email:</label>
			<div class="layui-input-inline">
				<input type="text" name="user_email"  placeholder="" autocomplete="off" class="layui-input">
			</div>
			<div class="layui-form-mid layui-word-aux">
				<span style="color: red">*</span>比如:admin123@163.com
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">出生日期:</label>
			<div class="layui-input-inline">
				<input id="um_user_birthdate" type="text" name="user_birthdate" lay-verify="" placeholder="" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">性&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp别:</label>
			<div class="layui-input-block">
				<input type="radio" name="user_sex" value="1" title="男"> <input type="radio" name="user_sex" value="2" title="女">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">账号状态:</label>
			<div class="layui-input-inline">
				<select name="account_state" lay-search="">
					<option value="">直接选择</option>
					<option value="1">启用</option>
					<option value="2">禁用</option>
				</select>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-input-block">
				<button class="layui-btn layui-btn-radius layui-btn-primary" lay-submit lay-filter="um_submit">保存</button>
				<button id="cancel" class="layui-btn layui-btn-radius layui-btn-primary">取消</button>
			</div>
		</div>
	</form>
	<script type="text/javascript" src="../javaScript/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="../javaScript/cookie_util.js"></script>
	<script type="text/javascript" src="../javaScript/js/global-path.js"></script>
	<script type="text/javascript" src="../javaScript/javascriptUtil.js"></script>
	<script type="text/javascript" src="../javaScript/ztree/jquery.ztree.core.js"></script>
	<script type="text/javascript">
		layui.use(
			[ 'layer', 'form', 'table', 'element','laydate' ], function()
			{
				var element = layui.element, layer = layui.layer, form = layui.form, table = layui.table,laydate = layui.laydate;
				$ = layui.$;
				$(function()
					{
						var str = getCookie("user");// 从Cookie中取出管理员信息
						var data = JSON.parse(str);
						var user_id = null;// 管理员ID
						var zTreeObj;//ztree的全局对象
						var $node_id;//当前节点ID
						var $node_name;//当前节点名称
						var $node_pid;//当前节点的父节点ID
						var uos_id;//点击获取的组织节点ID
						var tr_user_id=[];//数据行tr行对应的user_id数组
						var checkbox_checked;//表格多选的监听状态true,false
						var checkbox_type;//表格多洗监听的类型all,one
						//添加开始时间控件
						laydate.render(
							{
								elem : '#um_user_birthdate',
								type : 'date'
							});
						if (data != null)
							{
								user_id = data.user_id;
							}
						//初始化组织结构树(ztree)
						(function()
							{
								var ajson =
									{
										url : path + "UserManagement/findOrganizationStructureByUserId.do",
										data :
											{
												user_id : user_id
											},
										success : function(result)
											{
												var data = result.data;
												var state = result.state;
												var message = result.message;
												if (state == 0)
													{
														if (data[0].pid == null || typeof data[0].pid == 'undefined')
															{
																$node_name = data[0].name;
																$node_id = data[0].id;
															}
														// zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）		
														var setting =
															{
																data :
																	{
																		simpleData :
																			{
																				enable : true,
																				idKey : "id",
																				pIdKey : "pid",
																				rootPId : ""
																			}
																	},
																callback :
																	{
																		onClick : function(event, treeId, treeNode)
																			{
																				uos_id = treeNode.id;
																				addCookie('uos_id', uos_id, 1);
																				tableRender(user_id, uos_id);
																			}
																	}
															};
														//初始化组织结构树
														zTreeObj = $.fn.zTree.init($("#oaganization_tree"), setting, data);
													}
												if (state != 0)
													{
														layer.msg(message);
													}
											}
									};
								//自定义AJAX函数
								ajaxReturnJson(ajson);
								//初始化试卷表格
								tableIns = table.render(
									{
										elem : '#um_c_table',
										height : 'full-200',
										url : path + 'examroom/findUserInfoByUserID.do' //数据接口
										,
										where :
											{
												user_id : user_id
											},
										method : 'post',
										page : true //开启分页
										,
										cols :
											[
												[ //表头
													{
														type : 'checkbox'
													},
													{
														field : 'RN',
														title : '序号',
														sort : true,
														align : 'center',
													},
													{
														field : 'USER_ACCOUNT',
														title : '账号',
														sort : true,
														align : 'center',
													},
													{
														field : 'USER_NAME',
														title : '姓名',
														align : 'center',
													},
													{
														field : 'USER_CERTIFICAITON_NUM',
														title : '证件号',
														align : 'center',
													},
													{
														field : 'USER_COMPANY',
														title : '单位',
														align : 'center',
													}] ],
										limit : 10,
										request :
											{
												pageName : 'page' //页码的参数名称，默认：page
												,
												limitName : 'limit' //每页数据量的参数名，默认：limit
											},
										response :
											{
												statusName : 'state' //数据状态的字段名称，默认：code
												,
												msgName : '' //状态信息的字段名称，默认：msg
												,
												countName : 'total' //数据总数的字段名称，默认：count
												,
												dataName : 'data' //数据列表的字段名称，默认：data
											},
										done : function(res, curr, count)//异步请求数据的回调
											{
												var state = res.state;
												if (state != 0)
													{
														layer.msg('暂无用户数据');
													}

											}
									});
							})();
						//前端搜索,快速定位搜索框
						$("#keyword").bind('input propertychange', function()
							{
								$('tr[data-index]').hide().filter(":contains(" + $(this).val() + ")").show();
							})
						//监听单元格事件
						table.on('tool(um_c_table_filter)', function(obj)
							{
								var data = obj.data;
								if (obj.event === 'setSign')
									{
										if (data.PERMISSION == '修改')
											{
												//修改用户弹出层
												layer.open(
													{
														type : 1,
														//skin: 'mylayer-class',弹出层样式
														title : '修改用户',
														area :
															[ '800px', '600px' ],
														content :$('#update_person_form')
													// 这里content是一个普通的String
													});
												tr_user_id=data.USER_ID;
												$('#update_person_form input[name=user_account]').val(data.USER_ACCOUNT);
												$('#update_person_form input[name=user_name]').val(data.USER_NAME);
												$('#update_person_form input[name=role_name]').val(data.ROLE_NAME);
												$('#update_person_form input[name=user_certificaiton_num]').val(data.USER_CERTIFICAITON_NUM);
												$('#update_person_form input[name=user_company]').val(data.USER_COMPANY);
												$('#update_person_form input[name=user_phone_num]').val(data.USER_PHONE_NUM);
												$('#update_person_form input[name=user_email]').val(data.USER_EMAIL);
												$('#update_person_form input[name=user_birthdate]').val(data.USER_BIRTHDATE);
												if (data.USER_SEX == '1')
													{
														$('#update_person_form input[title=男]').prop('checked', true);
													} else if (data.USER_SEX == '2')
													{
														$('#update_person_form input[title=女]').prop('checked', true);
													}
												if(data.USER_ACCOUNT_STATE=='启用'){
													$('#update_person_form option[value=1]').attr("selected","selected");
												}else if(data.USER_ACCOUNT_STATE=='未启用'){
													$('#update_person_form option[value=2]').attr("selected","selected");
												}
												$('input[name=user_account],input[name=role_name],input[name=user_certificaiton_num]').attr("readonly", "readonly");
												form.render();
												return false;
											}
									}
							});
						
						table.on('checkbox(um_c_table_filter)', function(obj){
							if(obj.checked==true&&obj.type=='one'){
								tr_user_id.push(obj.data.USER_ID);
							}
							if(obj.checked==false&&obj.type=='one'){
								tr_user_id.remove(obj.data.USER_ID);
							}
							checkbox_checked=obj.checked;
							checkbox_type=obj.type;
						});
						
						//添加新用户单击事件
						$('#um_create_person').click(function()
							{
								if (typeof uos_id == 'undefined' || uos_id == null)
									{
										layer.msg("请选择用户要建立在哪级组织下");
										return false;
									}
								//新增用户弹出层
								layer.open(
									{
										type : 2,
										//skin: 'mylayer-class',弹出层样式
										title : '添加新用户',
										area :
											[ '800px', '600px' ],
										content : 'um_create_person.html'
									// 这里content是一个普通的String
									});
							});
						
						/* 提交并保存用户信息*/
						form.on('submit(um_submit)', function(data)
							{
								data.field.user_id=tr_user_id;
								var ajson =
									{
										url : path + "UserManagement/updateUser.do",
										data : data.field
									}; 
								//自定义AJAX函数
								ajaxReturnMessage(ajson);
							});
						//点击取消弹出层
						$('#cancel').click(function()
							{
								layer.closeAll();
							});
						//初始化密码
						$('#reset_password').click(function(){
							layer.open({
								  content: '是否将所有用户'
								  ,btn: ['确定', '取消']
								  ,yes: function(index, layero){
								   	if(checkbox_checked==true&&checkbox_type=='all'){
								   		console.log(checkbox_type);
								   		var ajson =
												{
													url : path + "UserManagement/updatePasswordOfAllUser.do",
												}; 
											//自定义AJAX函数
											ajaxReturnMessage(ajson);
								   	}else{
								   		var ajson =
												{
													url : path + "UserManagement/updatePasswordByID.do",
													data :{user_ids:tr_user_id}
												}; 
											//自定义AJAX函数
											ajaxReturnMessage(ajson);
								   	}	
								  }
								  ,btn2: function(index, layero){
									  layer.closeAll('dialog');
								  }
								  ,cancel: function(){ 
									  layer.closeAll('dialog');
								  }
								});
							
						});
						 
					})
				//表格重载
				function tableRender(user_id, uos_id)
					{
						tableIns.reload(
							{
								url : path + 'UserManagement/findUserInfoByUosID.do' //数据接口
								,
								where :
									{ //设定异步数据接口的额外参数
										user_id : user_id,
										uos_id : uos_id
									},
								page :
									{
										curr : 1
									//重新从第 1 页开始
									}
							});
					}
			});
	</script>
</body>


</html>