<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>考场管理</title>
<link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
<script type="text/javascript" src="../../layui/layui.js"></script>
<style type="text/css">
html, body {
	height: 100%;
	background-color: #fff;
	position: relative;
}

#em_bt {
	position:absolute;
	right:100px;
	margin-top: 5px;
}

.layui-input-block {
	width: 500px;
}

#em_body {
	position:absolute;
	border-top:1.5px solid #C9C9C9;
	width: 100%;
	display: flex;
}

.layui-form {
	margin: auto;
}
.layui-input{
white-space : normal nowrap 
}
#em_body>.layui-form input{
	width: 500px;
}
.star{
	position: absolute;
	left:310px;
	color: red;
	font-size: 20px;
}
.layui-form-item{
	margin-top: 40px;
}
/*考试管理head高度*/
#em_head{
height: 50px;
}

.layui-form,button[type=reset]{
	display: none;
}
</style>
</head>
<body>
	<div id="em_head">
	<button id="em_bt" class="layui-btn layui-btn-normal">
		<i class="layui-icon">&#xe608;</i>添加新考场
	</button>
	</div>
	<div id="em_body">
		<form class="layui-form">
			<div class="layui-form-item">
				<label class="layui-form-label">考场名称:</label>
				<div class="layui-input-inline">
					<input type="text" name="examroom_name" required lay-verify="required" placeholder="请输入考场名称" class="layui-input">
				</div>
				 <div class="layui-form-mid layui-word-aux"><span class="star">*</span></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">考生数量:</label>
				<div class="layui-input-inline">
					<input type="text" name="examroom_max_person" required lay-verify="examroom_max_person" placeholder="容纳考生数量" class="layui-input">
				</div>
				 <div class="layui-form-mid layui-word-aux"><span class="star">*</span></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">开考时间:</label>
				<div class="layui-input-inline">
					<input type="text" name="examroom_begin_time" id="examroom_begin_time" lay-verify="date" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input">
				</div>
				 <div class="layui-form-mid layui-word-aux"><span class="star">*</span></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">结束时间:</label>
				<div class="layui-input-inline">
					<input type="text" name="examroom_end_time" id="examroom_end_time" lay-verify="date" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input">
				</div>
				 <div class="layui-form-mid layui-word-aux"><span class="star">*</span></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">考场地点:</label>
				<div class="layui-input-inline">
					<input type="text" name="examroom_place" lay-verify="required" placeholder="请输入考场地点" class="layui-input">
				</div>
				 <div class="layui-form-mid layui-word-aux"><span class="star">*</span></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">锁定考场</label>
				<div class="layui-input-inline">
					<input type="checkbox" value="on" name="examroom_lock_status" title="是否锁定">
				</div>
			</div>
			<div class="layui-form-item">
				<div class="layui-input-block">
					<button class="layui-btn" lay-submit="" lay-filter="submit">立即提交</button>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
					<button type="cancel" class="layui-btn layui-btn-primary">取消</button>
				</div>
			</div>
		</form>
		<table id="em_table" class="layui-table" lay-filter="em_table_filter" lay-skin="line"></table>
	</div>
	<script type="text/javascript" src="../../javaScript/javascriptUtil.js"></script>
	<script type="text/javascript" src="../../javaScript/cookie_util.js"></script>
	<script type="text/javascript" src="../../javaScript/js/global-path.js"></script>
	<script type="text/javascript" src="../../javaScript/jquery-1.11.1.js"></script>
	<script type="text/javascript">
		layui.use(
			[ 'layer', 'form', 'table', 'element', 'laydate' ], function()
			{
				var layer = layui.layer, form = layui.form, table = layui.table, laydate = layui.laydate, $ = layui.$;

				$(function()
					{
						//封装表单数据的JSON对象
						jsonData =
							{};
						//添加开始时间控件
						laydate.render(
							{
								elem : '#examroom_begin_time',
								type : 'datetime',
								done : function(value, date, endDate)
									{
										jsonData.start_time = value.trim();
									}
							});
						//添加结束时间控件
						laydate.render(
							{
								elem : '#examroom_end_time',
								type : 'datetime',
								done : function(value, date, endDate)
									{
										jsonData.end_time = value.trim();
										/* console.log(endDate);
										if (typeof jsonData.start_time != 'undefined')
											{
												jsonData.end_time = value.trim();
												var start_time=new Date(jsonData.start_time);
												var end_time=new Date(jsonData.end_time);
												if((end_time.getTime()-start_time.getTime())<0){
													console.log(1);
													$('#examroom_end_time').val(null);
													return false;
												}
												
											} */
									}
							});
						//表单验证
						form.verify({
							  //日期格式的验证
							  date: function(value, item){ //value：表单的值、item：表单的DOM对象 
								  if(value==''){
								      return '请输入日期';
								    }
								    if(!/^(?:19|20)[0-9][0-9]-(?:(?:0[1-9])|(?:1[0-2]))-(?:(?:[0-2][1-9])|(?:[1-3][0-1])) (?:(?:[0-2][0-3])|(?:[0-1][0-9])):[0-5][0-9]:[0-5][0-9]$/.test(value)){
								      return '日期格式不正确';
								    }
								  },
							 //考生最大人数的验证
							 examroom_max_person: function(value, item){ //value：表单的值、item：表单的DOM对象
									    if(!/^[0-9]*$/.test(value)){
									      return '考生数量格式不正确';
									    }
									  }
							}); 
						var $hashcode=0;
						//点击提交按钮,新增考场信息
						form.on('submit(submit)', function(data){
							var start_time=new Date(data.field.examroom_begin_time);
							var end_time=new Date(data.field.examroom_end_time);
							if($hashcode==hashcode(data.field.examroom_name)){
								return false;
							}
							$hashcode=hashcode(data.field.examroom_name);
							if((end_time.getTime()-start_time.getTime())<0){
								layer.msg("考试结束时间不能小于开考时间");
								return false;
							}
							var str = getCookie("user");//从Cookie中取出管理员信息
							if(str==null||typeof str=='undefined'){
								alert("不能获取用户信息,请重新登录");
							}
							//获取考试创建人
							data.field.examroom_create_person = JSON.parse(str).user_name;
							var ajson={
									url:"examroom/addExamroom.do",
									data:data.field,
									success: function (result)
										{
											var state = result.state;
											var data = result.data;
											var message = result.message;
											if (state == 0)
												{
													layer.msg(data);
												} else
												{
													layer.msg(message);
												}
											return false;// 阻止表单跳转
										}
							};
							//自定义AJAX函数
							ajaxJson(ajson);
							return false;
							});
						//添加新考场按钮添加单击事件，展示并重置表单
						$('#em_bt').click(function(){
							$('button[type=reset]').click();
							$('.layui-form').show();
						});
						//取消按钮添加点击事件，并隐藏表单
						$('button[type=cancel]').click(function(){
							$('.layui-form').hide();
						});
						
						//初始化试卷表格
						table.render(
							{ 
								elem : '#examin_paper',
								height : 315,
								url : path + 'examroom/findAllExaminPaper.do' //数据接口
								,
								method : 'post',
								page : true //开启分页
								,
								cols :
									[
										[ //表头
											{
												field : 'EXAM_ID',
												title : '序号',
												sort : true,
												align : 'center',
											},
											{
												field : 'EXAM_NAME',
												title : '考卷名',
												align : 'center',
											}] ],
								limit : 10,
								request :
									{
										pageName : 'page' //页码的参数名称，默认：page
										,
										limitName : 'limit' //每页数据量的参数名，默认：limit
									},
								response :
									{
										statusName : 'state' //数据状态的字段名称，默认：code
										,
										msgName : '' //状态信息的字段名称，默认：msg
										,
										countName : 'total' //数据总数的字段名称，默认：count
										,
										dataName : 'data' //数据列表的字段名称，默认：data
									},
								done : function(res, curr, count)//异步请求数据的回调
									{
										var state=res.state;
										if(state!=0){
											layer.msg('暂无试卷相关数据');
										}
									}
							});
						//load时重新加载表单
						form.render();
					})
					
			});
	</script>
</body>


</html>